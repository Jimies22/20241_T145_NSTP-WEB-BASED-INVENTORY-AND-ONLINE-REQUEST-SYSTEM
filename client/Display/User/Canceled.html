<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- My CSS -->
	<link rel="stylesheet" href="Canceled.css">

	<title>Canceled Requests</title>
	
	<script src="../../js/notifications.js"></script>
</head>
<body>


	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<img src="img/NSTP_LOGO.png" alt="Admin Logo" class="brand" />
			<span class="text">Admin</span>
		</a>
		<ul class="side-menu top">
			<li>
				<a href="Dashboard.html">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li>
				<a href="#">
					<i class='bx bxs-shopping-bag-alt' ></i>
					<span class="text">Request</span>
				</a>
			</li>
			<li>
				<a href="Borroweditems.html">
					<i class='bx bxs-book'></i>
					<span class="text">Borrowed Items</span>
				</a>
			</li>
			<li>
				<a href="Reports.html">
					<i class='bx bxs-message-dots' ></i>
					<span class="text">Reports</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<!-- <li>
				<a href="#">
					<i class='bx bxs-cog' ></i>
					<span class="text">Settings</span>
				</a>
			</li> -->
			<li>
				<a href="../login/login.html" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->



	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu' ></i>
			<a href="#" class="nav-link">Categories</a>
			<form action="#">
				<div class="form-input">
					<input type="search" placeholder="Search...">
					<button type="submit" class="search-btn"><i class='bx bx-search' ></i></button>
				</div>
			</form>
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
			<div class="notification-container">
				<a href="Notification.html" class="notification">
					<i class='bx bxs-bell'></i>
					<span class="badge" id="notification-count">0</span>
				</a>
			</div>
			<a href="StaffProfile.html" class="profile">
				<img src="img/Screen-Shot-2024-06-11-at-11.54.30-AM-e1718634535872.webp">
			</a>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Canceled Requests</h1>
					<ul class="breadcrumb">
						<li>
							<a href="#">Canceled</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="Requestpage.html">Request</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="Dashboard.html">Home</a>
						</li>
					</ul>
				</div>
				<!-- <a href="#" class="btn-download">
					<i class='bx bxs-cloud-download' ></i>
					<span class="text">Download PDF</span>
				</a> -->
			</div>
			<div class="table-data">
				<div class="canceled-requests">
					<div class="head">
						<h3>Canceled Requests</h3>
						<div class="filter-container">
							<i class='bx bx-filter' id="filterIcon"></i>
							<div class="filter-dropdown">
								<div class="filter-option" data-sort="date-newest">Sort by Date (Newest)</div>
								<div class="filter-option" data-sort="date-oldest">Sort by Date (Oldest)</div>
								<div class="filter-option" data-sort="name-asc">Sort by Name (A-Z)</div>
								<div class="filter-option" data-sort="name-desc">Sort by Name (Z-A)</div>
							</div>
						</div>
					</div>
					<div class="order">
						<table>
							<thead>
								<tr>
									<th>Item Description</th>
									<th>Status</th>
									<th>Canceled Date</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody id="canceled-items-list">
								<!-- Items will be inserted here dynamically -->
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</main>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->
	

	<script>
		let currentSort = ''; // Track current sort type

		document.addEventListener('DOMContentLoaded', function() {
			console.log('Page loaded'); // Debug log
			displayCanceledItems();

			const filterIcon = document.getElementById('filterIcon');
			const filterDropdown = document.querySelector('.filter-dropdown');
			
			// Toggle dropdown on icon click
			filterIcon.addEventListener('click', function(e) {
				e.stopPropagation();
				filterDropdown.classList.toggle('show');
			});

			// Close dropdown when clicking outside
			document.addEventListener('click', function(e) {
				if (!filterDropdown.contains(e.target) && e.target !== filterIcon) {
					filterDropdown.classList.remove('show');
				}
			});

			// Handle filter options
			document.querySelectorAll('.filter-option').forEach(option => {
				option.addEventListener('click', function(e) {
					e.stopPropagation();
					const sortType = this.dataset.sort;
					
					// Remove active class from all options
					document.querySelectorAll('.filter-option').forEach(opt => {
						opt.classList.remove('active');
					});
					
					// Add active class to clicked option
					this.classList.add('active');
					
					// Sort items (your existing sort function)
					sortItems(sortType);
					
					// Close dropdown
					setTimeout(() => {
						filterDropdown.classList.remove('show');
					}, 150);
				});
			});

			// Add notification count update
			updateNotificationCount();

			initializeNotifications();
		});

		function sortItems(sortType) {
			const canceledItems = JSON.parse(localStorage.getItem('canceledItems')) || [];
			
			switch(sortType) {
				case 'date-newest':
					canceledItems.sort((a, b) => new Date(b.canceledAt) - new Date(a.canceledAt));
					break;
				case 'date-oldest':
					canceledItems.sort((a, b) => new Date(a.canceledAt) - new Date(b.canceledAt));
					break;
				case 'name-asc':
					canceledItems.sort((a, b) => a.title.localeCompare(b.title));
					break;
				case 'name-desc':
					canceledItems.sort((a, b) => b.title.localeCompare(a.title));
					break;
			}

			displayCanceledItems(canceledItems);
		}

		// Update the display function to accept sorted items
		function displayCanceledItems(items = null) {
			const tableBody = document.getElementById('canceled-items-list');
			const canceledItems = items || JSON.parse(localStorage.getItem('canceledItems')) || [];
			
			if (canceledItems.length === 0) {
				tableBody.innerHTML = `
					<tr>
						<td colspan="4">
							<div class="empty-state">
								<i class='bx bx-calendar-x'></i>
								<p>No canceled requests found</p>
							</div>
						</td>
					</tr>
				`;
				return;
			}
			
			tableBody.innerHTML = '';
			
			canceledItems.forEach(item => {
				try {
					const canceledDate = new Date(item.canceledAt).toLocaleDateString();
					const row = `
						<tr>
							<td class="item-info">
								<img src="${item.image || 'placeholder.jpg'}" alt="${item.title}">
								<p>${item.title}</p>
							</td>
							<td><span class="status canceled">CANCELED</span></td>
							<td>${canceledDate}</td>
							<td>
								<button class="delete-btn" onclick="deleteCanceledItem('${item.id}')">
									<i class='bx bx-trash'></i>
								</button>
							</td>
						</tr>
					`;
					tableBody.innerHTML += row;
				} catch (error) {
					console.error('Error creating row for item:', item, error);
				}
			});
		}

		// Debug function to check localStorage
		function checkLocalStorage() {
			console.log('All localStorage items:');
			for (let i = 0; i < localStorage.length; i++) {
				const key = localStorage.key(i);
				console.log(`${key}:`, localStorage.getItem(key));
			}
		}

		// Call debug function
		checkLocalStorage();

		// Update the delete function
		function deleteCanceledItem(itemId) {
			if (!confirm('Are you sure you want to delete this canceled request?')) {
				return;
			}

			try {
				let canceledItems = JSON.parse(localStorage.getItem('canceledItems')) || [];
				const itemToDelete = canceledItems.find(item => item.id === itemId);
				
				if (!itemToDelete) {
					throw new Error('Item not found');
				}
				
				// Remove the item
				canceledItems = canceledItems.filter(item => item.id !== itemId);
				localStorage.setItem('canceledItems', JSON.stringify(canceledItems));
				
				// Add to notifications
				const notification = {
					id: generateUniqueId(),
					type: 'CANCELED_DELETE',
					title: 'Request Deleted',
					message: `The canceled request "${itemToDelete.title}" has been permanently deleted`,
					timestamp: new Date().toISOString(),
					read: false,
					itemDetails: itemToDelete
				};

				// Get existing notifications and add new one
				let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
				notifications.unshift(notification);

				// Keep only the most recent notifications (e.g., last 50)
				const maxNotifications = 50;
				if (notifications.length > maxNotifications) {
					notifications = notifications.slice(0, maxNotifications);
				}

				localStorage.setItem('notifications', JSON.stringify(notifications));
				
				// Update shared notification count in localStorage
				const currentCount = parseInt(localStorage.getItem('notificationCount') || '0');
				localStorage.setItem('notificationCount', currentCount + 1);
				
				// Show success notification
				showNotification('Request deleted successfully', 'success');
				
				// Update notification count display
				updateNotificationCount();
				
				// Refresh display
				displayCanceledItems();
				
			} catch (error) {
				console.error('Error deleting item:', error);
					showNotification('Failed to delete request', 'error');
			}
		}

		// Helper function to generate unique ID
		function generateUniqueId() {
			return Date.now().toString(36) + Math.random().toString(36).substr(2);
		}

		// Updated notification function to match other notifications styling
		function showNotification(message, type = 'success') {
			const notificationContainer = document.createElement('div');
			notificationContainer.className = 'notification-popup';
			
			const icon = document.createElement('i');
			icon.className = type === 'success' ? 'bx bx-check-circle' : 'bx bx-x-circle';
			
			const textContainer = document.createElement('div');
			textContainer.className = 'notification-text';
			
			const title = document.createElement('span');
			title.className = 'notification-title';
			title.textContent = type === 'success' ? 'Success' : 'Error';
			
			const text = document.createElement('span');
			text.className = 'notification-message';
			text.textContent = message;
			
			textContainer.appendChild(title);
			textContainer.appendChild(text);
			
			notificationContainer.appendChild(icon);
			notificationContainer.appendChild(textContainer);
			
			document.body.appendChild(notificationContainer);
			
			// Add show class after a brief delay to trigger animation
			setTimeout(() => {
				notificationContainer.classList.add('show');
			}, 10);
			
			// Remove notification after 3 seconds
			setTimeout(() => {
				notificationContainer.classList.remove('show');
				setTimeout(() => {
					notificationContainer.remove();
				}, 300); // Wait for fade out animation
			}, 3000);
		}

		// Update the notification count function
		function updateNotificationCount() {
			const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
			const unreadCount = notifications.filter(notification => !notification.read).length;
			
			// Update the count in localStorage
			localStorage.setItem('notificationCount', unreadCount.toString());
			
			// Update the display
			const countElement = document.getElementById('notification-count');
			if (countElement) {
				countElement.textContent = unreadCount;
				
				// Add animation class if count increased
				countElement.classList.add('pulse');
				setTimeout(() => {
					countElement.classList.remove('pulse');
				}, 500);
			}
		}

		// Add this function to initialize notification handling
		function initializeNotifications() {
			// Initial count update
			updateNotificationCount();
			
			// Listen for storage changes from other tabs/windows
			window.addEventListener('storage', (e) => {
				if (e.key === 'notifications' || e.key === 'notificationCount') {
					updateNotificationCount();
				}
			});
		}
	</script>
</body>
</html>