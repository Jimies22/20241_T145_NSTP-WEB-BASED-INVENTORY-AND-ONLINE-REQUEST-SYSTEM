<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- My CSS -->
	<link rel="stylesheet" href="Requestpage.css">
	<link rel="stylesheet" href="overlay.css">

	<title>User</title>

	<!-- Add in the head section -->
	<script src="js/notifications.js"></script>
</head>
<body>


	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<img src="img/NSTP_LOGO.png" alt="Admin Logo" class="brand" />
			<span class="text">User</span>
		</a>
		<ul class="side-menu top">
			<li>
				<a href="Dashboard.html">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li>
				<a href="#">
					<i class='bx bxs-shopping-bag-alt' ></i>
					<span class="text">Request</span>
				</a>
			</li>
			<li>
				<a href="Borroweditems.html">
					<i class='bx bxs-book'></i>
					<span class="text">Borrowed Items</span>
				</a>
			</li>
			<li>
				<a href="Reports.html">
					<i class='bx bxs-message-dots' ></i>
					<span class="text">Reports</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<!-- <li>
				<a href="#">
					<i class='bx bxs-cog' ></i>
					<span class="text">Settings</span>
				</a>
			</li> -->
			<li>
				<a href="../login/login.html" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->



	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu' ></i>
			<a href="#" class="nav-link">Categories</a>
			<form action="#">
				<div class="form-input">
					<input type="search" placeholder="Search...">
					<button type="submit" class="search-btn"><i class='bx bx-search' ></i></button>
				</div>
			</form>
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
			<a href="Notification.html" class="notification">
				<i class='bx bxs-bell'></i>
				<span class="num">0</span>
			</a>
			<a href="StaffProfile.html" class="profile">
				<img src="img/Screen-Shot-2024-06-11-at-11.54.30-AM-e1718634535872.webp">
			</a>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Request</h1>
					<ul class="breadcrumb">
						<li>
							<a href="#">Request</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="Canceled.html">Canceled</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="Dashboard.html">Home</a>
						</li>
					</ul>
				</div>
				<!-- <a href="#" class="btn-download">
					<i class='bx bxs-cloud-download' ></i>
					<span class="text">Download PDF</span>
				</a> -->
			</div>
			<div class="table-data">
				<div class="pending-requests">
					<div class="head">
						<h3>Pending Requests</h3>
						<i class='bx bx-filter'></i>
					</div>
					<div class="order">
						<table>
							<thead>
								<tr>
									<th>Item Description</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody id="requested-items-list">
								<!-- Items will be inserted here dynamically -->
							</tbody>
						</table>
					</div>
				</div>			
				<!-- <div class="todo">
					<div class="head">
						<h3>Todos</h3>
						<i class='bx bx-plus' ></i>
						<i class='bx bx-filter' ></i>
					</div>
					<ul class="todo-list">
						<li class="completed">
							<p>Todo List</p>
							<i class='bx bx-dots-vertical-rounded' ></i>
						</li>
						<li class="completed">
							<p>Todo List</p>
							<i class='bx bx-dots-vertical-rounded' ></i>
						</li>
						<li class="not-completed">
							<p>Todo List</p>
							<i class='bx bx-dots-vertical-rounded' ></i>
						</li>
						<li class="completed">
							<p>Todo List</p>
							<i class='bx bx-dots-vertical-rounded' ></i>
						</li>
						<li class="not-completed">
							<p>Todo List</p>
							<i class='bx bx-dots-vertical-rounded' ></i>
						</li>
					</ul>
				</div> -->
			</div>
		</main>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->
	

	<script src="script.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			updateTable(); // Initial table load

			// Get overlay elements
			const overlay = document.getElementById('orderOverlay');
			const closeBtn = document.querySelector('.close-btn');
			const cancelBtn = document.querySelector('.cancel-request-btn');

			if (!overlay || !closeBtn || !cancelBtn) {
				console.error('Required overlay elements not found');
				return;
			}

			// Close button event listener
			closeBtn.addEventListener('click', closeOverlay);

			// Cancel button event listener
			cancelBtn.addEventListener('click', function() {
				const currentItemId = overlay.dataset.currentItemId;
				if (currentItemId) {
					cancelRequest(currentItemId);
				} else {
					console.error('No item ID found');
				}
			});

			// Close overlay when clicking outside
			overlay.addEventListener('click', function(e) {
				if (e.target === overlay) {
					closeOverlay();
				}
			});
		});

		function updateTable() {
			const tableBody = document.getElementById('requested-items-list');
			const requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
			
			tableBody.innerHTML = ''; // Clear existing rows
			
			requestedItems.forEach(item => {
				const row = `
					<tr data-item='${JSON.stringify(item)}'>
						<td>
							<img src="${item.image}" alt="${item.title}">
							<p>${item.title}</p>
						</td>
						<td><span class="status pending">PENDING</span></td>
					</tr>
				`;
				tableBody.innerHTML += row;
			});

			// Add click listeners to new rows
			const rows = tableBody.getElementsByTagName('tr');
			Array.from(rows).forEach(row => {
				row.addEventListener('click', function() {
					const item = JSON.parse(this.dataset.item);
					showOrderDetails(item);
				});
			});
		}

		function showOrderDetails(item) {
			console.log('Showing details for item:', item);
			const overlay = document.getElementById('orderOverlay');
			
			// Store the current item ID in the overlay's dataset
				overlay.dataset.currentItemId = item.id;
			console.log('Set currentItemId to:', item.id);

			// Update overlay content
			document.getElementById('orderImage').src = item.image;
			document.getElementById('orderImage').alt = item.title;
			document.getElementById('orderId').textContent = item.id || 'N/A';
			document.getElementById('itemDescription').textContent = item.title;
			document.getElementById('borrowDate').textContent = item.date || 'N/A';
			document.getElementById('borrowTime').textContent = item.time || 'N/A';

			// Show overlay with animation
			overlay.style.display = 'block';
			setTimeout(() => {
				overlay.classList.add('active');
			}, 10);
		}

		function cancelRequest(itemId) {
			console.log('Cancel request initiated for ID:', itemId);
			
			if (!confirm('Are you sure you want to cancel this request?')) {
				return;
			}

			try {
				// Get current items from localStorage
				let requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
				let canceledItems = JSON.parse(localStorage.getItem('canceledItems')) || [];
				
				// Find the item to cancel
				const itemToCancel = requestedItems.find(item => item.id === itemId);
				
				if (!itemToCancel) {
					console.error('Item not found:', itemId);
					alert('Error: Item not found');
					return;
				}

				// Add cancellation details to the item
				const canceledItem = {
					...itemToCancel,
					canceledDate: new Date().toLocaleDateString(),
					canceledTime: new Date().toLocaleTimeString(),
					status: 'CANCELED',
					canceledAt: new Date().toISOString()
				};

				// Remove item from requested items
				requestedItems = requestedItems.filter(item => item.id !== itemId);
				
				// Add to canceled items
				canceledItems.push(canceledItem);

				// Update localStorage
				localStorage.setItem('requestedItems', JSON.stringify(requestedItems));
				localStorage.setItem('canceledItems', JSON.stringify(canceledItems));

				// Create and save notification
				const notification = {
					id: 'notif_' + Date.now(),
					type: 'cancel-request',
					title: 'Request Canceled',
					message: `Your request for ${canceledItem.title} has been canceled`,
					timestamp: new Date().toISOString(),
					read: false
				};

				let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
				notifications.unshift(notification);
				localStorage.setItem('notifications', JSON.stringify(notifications));

				// Update notification count in the UI
				const notificationCount = document.querySelector('.notification .num');
				if (notificationCount) {
					notificationCount.textContent = notifications.filter(n => !n.read).length;
				}

				// Close overlay if it's open
				closeOverlay();
				
				// Show success message
				const successMessage = document.createElement('div');
				successMessage.className = 'success-message';
				successMessage.innerHTML = `
					<div class="success-content">
						<i class='bx bx-check-circle'></i>
						<p>Request canceled successfully!</p>
					</div>
				`;
				document.body.appendChild(successMessage);

				// Add show class after a brief delay
				setTimeout(() => {
					successMessage.classList.add('show');
				}, 10);

				// Remove success message and redirect
				setTimeout(() => {
					successMessage.remove();
					window.location.href = 'Canceled.html';
				}, 2000);

			} catch (error) {
				console.error('Error in cancelRequest:', error);
				alert('An error occurred while canceling the request');
			}
		}

		// Make sure the overlay close function exists
		function closeOverlay() {
			const overlay = document.getElementById('orderOverlay');
			if (overlay) {
				overlay.classList.remove('active');
				setTimeout(() => {
					overlay.style.display = 'none';
				}, 300);
			}
		}

		// Close overlay when clicking the close button
		document.querySelector('.close-btn').addEventListener('click', function() {
			document.getElementById('orderOverlay').style.display = 'none';
		});

		// Close overlay when clicking outside the content
		document.getElementById('orderOverlay').addEventListener('click', function(e) {
			if (e.target === this) {
				this.style.display = 'none';
			}
		});
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// Get requested items from localStorage
			const requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
			const requestContainer = document.querySelector('.request-container'); // Add this container in your HTML

			if (requestedItems.length === 0) {
				requestContainer.innerHTML = `
					<div class="no-requests">
						<i class='bx bx-package'></i>
						<p>No requests found</p>
					</div>
				`;
				return;
			}

			// Sort requests by date (newest first)
			requestedItems.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));

			// Display each request
			requestedItems.forEach(item => {
				const requestCard = document.createElement('div');
				requestCard.className = 'request-card';
				requestCard.innerHTML = `
					<div class="request-image">
						<img src="${item.image}" alt="${item.title}">
					</div>
					<div class="request-details">
						<h3>${item.title}</h3>
						<p class="request-date">Date: ${item.date}</p>
						<p class="request-time">Time: ${item.time}</p>
						<p class="request-status ${item.status.toLowerCase()}">${item.status}</p>
					</div>
					<div class="request-actions">
						<button class="cancel-btn" onclick="cancelRequest('${item.id}')">
							<i class='bx bx-x'></i>
							Cancel Request
						</button>
					</div>
				`;
				requestContainer.appendChild(requestCard);
			});
		});

		function cancelRequest(requestId) {
			// Show confirmation dialog
			if (!confirm('Are you sure you want to cancel this request?')) {
				return;
			}

			// Get requested items from localStorage
			let requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
			
			// Find the request to cancel
			const requestIndex = requestedItems.findIndex(item => item.id === requestId);
			if (requestIndex === -1) return;

			const canceledRequest = requestedItems[requestIndex];

			// Update request status
			canceledRequest.status = 'Canceled';
			requestedItems[requestIndex] = canceledRequest;
			localStorage.setItem('requestedItems', JSON.stringify(requestedItems));

			// Create notification for canceled request
			const notification = {
				id: 'notif_' + Date.now(),
				type: 'cancel-request',
				title: 'Request Canceled',
				message: `You have canceled your request for ${canceledRequest.title} scheduled for ${canceledRequest.date} at ${canceledRequest.time}`,
				timestamp: new Date().toISOString(),
				read: false
			};

			// Add notification to localStorage
			let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
			notifications.unshift(notification);
			localStorage.setItem('notifications', JSON.stringify(notifications));

			// Update notification count
			updateNotificationCount();

			// Show success message
			const successMessage = document.createElement('div');
			successMessage.className = 'success-message';
			successMessage.innerHTML = `
				<div class="success-content">
					<i class='bx bx-x-circle'></i>
					<p>Request canceled successfully!</p>
				</div>
			`;
			document.body.appendChild(successMessage);

			// Add show class after a brief delay
			setTimeout(() => {
				successMessage.classList.add('show');
			}, 10);

			// Remove success message after 2 seconds
			setTimeout(() => {
				successMessage.remove();
				// Refresh the page or update the UI
				location.reload();
			}, 2000);
		}
	</script>

	<!-- Add this right before the closing body tag -->
	<div id="orderOverlay" class="overlay">
		<div class="overlay-content">
			<span class="close-btn">&times;</span>
			<div class="order-details">
				<div class="order-image">
					<img id="orderImage" src="" alt="">
				</div>
				<div class="order-info">
					<div class="info-group">
						<label>Order ID:</label>
						<span id="orderId"></span>
					</div>
					<div class="info-group">
						<label>Item Description:</label>
						<span id="itemDescription"></span>
					</div>
					<div class="info-group">
						<label>Borrow Date:</label>
						<span id="borrowDate"></span>
					</div>
					<div class="info-group">
						<label>Borrow Time:</label>
						<span id="borrowTime"></span>
					</div>
				</div>
				<div class="action-buttons">
					<button class="cancel-request-btn" onclick="cancelRequest(this.closest('#orderOverlay').dataset.currentItemId)">
						Cancel Request
					</button>
				</div>
			</div>
		</div>
	</div>
</body>
</html>