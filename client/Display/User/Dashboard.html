<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Boxicons -->
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<!-- My CSS -->
	<link rel="stylesheet" href="Dashboard.css">

	<title>User</title>

	<!-- Google Calendar API configuration -->
	<script>
	const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
	const API_KEY = 'YOUR_GOOGLE_API_KEY';
	const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
	const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

	let tokenClient;
	let gapiInited = false;
	let gisInited = false;

	// Initialize the Google API
	function gapiLoaded() {
		gapi.load('client', initializeGapiClient);
	}

	async function initializeGapiClient() {
		await gapi.client.init({
			apiKey: API_KEY,
			discoveryDocs: [DISCOVERY_DOC],
		});
		gapiInited = true;
		maybeEnableButtons();
	}

	function gisLoaded() {
		tokenClient = google.accounts.oauth2.initTokenClient({
			client_id: CLIENT_ID,
			scope: SCOPES,
			callback: '', // defined later
		});
		gisInited = true;
		maybeEnableButtons();
	}

	function maybeEnableButtons() {
		if (gapiInited && gisInited) {
			document.querySelector('.borrow-btn').disabled = false;
		}
	}

	// Overlay functions
	function openOverlay(element) {
		const overlay = document.getElementById('overlay');
		const img = element.querySelector('img').src;
		const title = element.querySelector('h3').textContent;
		const status = element.querySelector('.status').textContent;

		document.getElementById('overlay-img').src = img;
		document.getElementById('overlay-title').textContent = title;
		document.getElementById('overlay-status').textContent = status;

		// Set minimum date to today
		const today = new Date().toISOString().split('T')[0];
		document.getElementById('booking-date').min = today;

		overlay.style.display = 'flex';
		requestAnimationFrame(() => {
			overlay.classList.add('active');
		});
	}

	function closeOverlay() {
		const overlay = document.getElementById('overlay');
		overlay.classList.remove('active');
		
		// Wait for animation to complete before hiding
		setTimeout(() => {
			overlay.style.display = 'none';
		}, 300);
	}

	async function handleBooking() {
		const date = document.getElementById('booking-date').value;
		const startTime = document.getElementById('start-time').value;
		const title = document.getElementById('overlay-title').textContent;
		const image = document.getElementById('overlay-img').src;
		const status = document.getElementById('overlay-status').textContent;

		if (!date || !startTime) {
			alert('Please select date and time');
			return;
		}

		try {
			// Create a unique ID for the request
			const requestId = 'req_' + Date.now();
			
			// Format the date and time for display
			const formattedDate = new Date(date).toLocaleDateString();
			const formattedTime = new Date(`2000/01/01 ${startTime}`).toLocaleTimeString([], { 
				hour: '2-digit', 
				minute: '2-digit' 
			});

			// Add item to requests list
			const requestItem = {
				id: requestId,
				title: title,
				image: image,
				date: formattedDate,
				time: formattedTime,
				rawDate: date, // Store raw date for sorting
				rawTime: startTime, // Store raw time for sorting
				status: 'Pending',
				requestedAt: new Date().toISOString(),
				itemStatus: status
			};

			// Get existing requests or initialize empty array
			let requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
			
			// Add new request to beginning of array
			requestedItems.unshift(requestItem);
			
			// Store updated requests
			localStorage.setItem('requestedItems', JSON.stringify(requestedItems));

			// Add notification for the booking
			const notification = {
				id: 'notif_' + Date.now(),
				type: 'booking',
				title: title,
				message: `You have requested to borrow ${title} for ${formattedDate} at ${formattedTime}`,
				timestamp: new Date().toISOString(),
				read: false,
				status: 'Pending'  // Add status to track the booking state
			};

			// Get existing notifications or initialize empty array
			let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
			notifications.unshift(notification);  // Add new notification at the beginning
			localStorage.setItem('notifications', JSON.stringify(notifications));

			// Update notification count immediately
			updateNotificationCount();

			// Show success message with notification icon
			const successMessage = document.createElement('div');
			successMessage.className = 'success-message';
			successMessage.innerHTML = `
				<div class="success-content">
					<i class='bx bx-check-circle'></i>
					<p>Request submitted successfully!</p>
					<p><i class='bx bx-bell'></i> Check your notifications for updates</p>
					<p>Redirecting to requests page...</p>
				</div>
			`;
			document.body.appendChild(successMessage);

			// Add animation class after a brief delay
			setTimeout(() => {
				successMessage.classList.add('show');
			}, 10);

			// Redirect after showing message
			setTimeout(() => {
				window.location.href = 'Requestpage.html';
			}, 2000);

		} catch (err) {
			console.error('Error processing request:', err);
			alert('Error submitting request. Please try again.');
		}
	}

	async function createCalendarEvent(event) {
		try {
			const response = await gapi.client.calendar.events.insert({
				'calendarId': 'primary',
				'resource': event
			});
			alert('Booking successful! Event added to your Google Calendar.');
			closeOverlay();
		} catch (err) {
			console.error('Error creating calendar event:', err);
			alert('Error creating calendar event. Please try again.');
		}
	}

	// Close overlay when clicking outside
	window.onclick = function(event) {
		const overlay = document.getElementById('overlay');
		if (event.target == overlay) {
			closeOverlay();
		}
	}

	// Close overlay when pressing ESC key
	document.addEventListener('keydown', function(event) {
		if (event.key === 'Escape') {
			closeOverlay();
		}
	});

	// Add this function after the existing script content
	function searchItems() {
		const searchInput = document.getElementById('searchInput');
		const searchTerm = searchInput.value.toLowerCase().trim();
		const projectorCards = document.querySelectorAll('.projector-card');

		projectorCards.forEach(card => {
			const title = card.querySelector('h3').textContent.toLowerCase();
			const status = card.querySelector('.status').textContent.toLowerCase();
			
			if (title.includes(searchTerm) || status.includes(searchTerm)) {
				card.style.display = '';
			} else {
				card.style.display = 'none';
			}
		});
	}

	// Add event listeners for both input changes and form submission
	document.addEventListener('DOMContentLoaded', function() {
		const searchInput = document.getElementById('searchInput');
		const searchForm = document.querySelector('form');

		// Search while typing
		searchInput.addEventListener('input', searchItems);

		// Handle form submission
		searchForm.addEventListener('submit', function(e) {
			e.preventDefault();
			searchItems();
		});

		// Add click handlers to all projector cards
		const projectorCards = document.querySelectorAll('.projector-card');
		projectorCards.forEach(card => {
			card.style.cursor = 'pointer';
			if (!card.hasAttribute('onclick')) {
				card.setAttribute('onclick', 'openOverlay(this)');
			}
		});

		// Add filter checkbox event listeners
		const filterCheckboxes = document.querySelectorAll('.filter-menu input[type="checkbox"]');
		filterCheckboxes.forEach(checkbox => {
			checkbox.addEventListener('change', filterItems);
		});

		// Close filter menu when clicking outside
		document.addEventListener('click', function(e) {
			const filterMenu = document.getElementById('filterMenu');
			const filterIcon = document.querySelector('.bx-filter');
			if (!filterMenu.contains(e.target) && e.target !== filterIcon) {
				filterMenu.classList.remove('active');
				setTimeout(() => {
					filterMenu.style.display = 'none';
				}, 300);
			}
		});

		// Initialize notification count
		updateNotificationCount();
	});

	function toggleFilterMenu() {
		const filterMenu = document.getElementById('filterMenu');
		if (!filterMenu.classList.contains('active')) {
			filterMenu.style.display = 'block';
			// Trigger reflow to ensure transition works
			filterMenu.offsetHeight;
			filterMenu.classList.add('active');
		} else {
			filterMenu.classList.remove('active');
			// Wait for transition to finish before hiding
			setTimeout(() => {
				filterMenu.style.display = 'none';
			}, 300);
		}
	}

	function filterItems() {
		const projectorCards = document.querySelectorAll('.projector-card');
		const selectedFilters = Array.from(document.querySelectorAll('.filter-menu input:checked'))
			.map(checkbox => checkbox.value);

		projectorCards.forEach(card => {
			const status = card.querySelector('.status').textContent.toLowerCase();
			const shouldShow = selectedFilters.some(filter => status.includes(filter));
			card.style.display = shouldShow ? '' : 'none';
		});
	}

	// Update the notification count function to be more visible
	function updateNotificationCount() {
		const notifications = JSON.parse(localStorage.getItem('notifications')) || [];
		const unreadCount = notifications.filter(notif => !notif.read).length;
		const numElement = document.querySelector('.notification .num');
		
		if (unreadCount > 0) {
			numElement.style.display = 'block';
			numElement.textContent = unreadCount;
			
			// Add a brief animation to make the notification more noticeable
			numElement.classList.remove('pulse');
			void numElement.offsetWidth; // Trigger reflow
			numElement.classList.add('pulse');
		} else {
			numElement.style.display = 'none';
		}
	}

	// Add function to handle request status changes
	function updateRequestStatus(requestId, newStatus) {
		let requestedItems = JSON.parse(localStorage.getItem('requestedItems')) || [];
		const request = requestedItems.find(item => item.id === requestId);
		
		if (request) {
			request.status = newStatus;
			localStorage.setItem('requestedItems', JSON.stringify(requestedItems));

			// Add notification for status change
			const notification = {
				id: 'notif_' + Date.now(),
				type: newStatus.toLowerCase(),
				title: request.title,
				message: `Your request for ${request.title} has been ${newStatus}`,
				timestamp: new Date().toISOString(),
				read: false
			};

			let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
			notifications.unshift(notification);
			localStorage.setItem('notifications', JSON.stringify(notifications));

			updateNotificationCount();
		}
	}
	</script>
</head>
<body>


	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<img src="img/NSTP_LOGO.png" alt="Admin Logo" class="brand" />
			<span class="text">User</span>
		</a>
		<ul class="side-menu top">
            <li>
				<a href="#">
					<i class='bx bxs-dashboard'></i>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li>
				<a href="Requestpage.html">
					<i class='bx bxs-shopping-bag-alt' ></i>
					<span class="text">Request</span>
				</a>
			</li>
            <li>
				<a href="Borroweditems.html">
					<i class='bx bxs-book'></i>
					<span class="text">Borrowed Items</span>
				</a>
			</li>
			<li>
				<a href="Reports.html">
                    <i class='bx bxs-report' ></i>
					<span class="text">Reports</span>
				</a>
			</li>
		</ul>
		<ul class="side-menu">
			<!-- <li>
				<a href="#">
					<i class='bx bxs-cog' ></i>
					<span class="text">Settings</span>
				</a>
			</li> -->
			<li>
				<a href="../login/login.html" class="logout">
					<i class='bx bxs-log-out-circle' ></i>
					<span class="text">Logout</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->



	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class='bx bx-menu'></i>
			<a href="#" class="nav-link">Categories</a>
			<form action="#">
				<div class="form-input">
					<input type="search" id="searchInput" placeholder="Search..." oninput="searchItems()">
					<button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
				</div>
			</form>
			<input type="checkbox" id="switch-mode" hidden>
			<label for="switch-mode" class="switch-mode"></label>
			<a href="Notification.html" class="notification">
				<i class='bx bxs-bell'></i>
				<span class="num">8</span>
			</a>
			<a href="StaffProfile.html" class="profile">
				<img src="img/Screen-Shot-2024-06-11-at-11.54.30-AM-e1718634535872.webp">
			</a>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Dashboard</h1>
					<ul class="breadcrumb">
						<li>
							<a href="#">Dashboard</a>
						</li>
						<li><i class='bx bx-chevron-right' ></i></li>
						<li>
							<a class="active" href="#">All Items</a>
                        </li>
                        <li>
                            <div class="filter-dropdown">
                                <i class='bx bx-filter' onclick="toggleFilterMenu()"></i>
                                <div id="filterMenu" class="filter-menu">
                                    <label><input type="checkbox" value="available" checked> Available</label>
                                    <label><input type="checkbox" value="borrowed"> Borrowed</label>
                                    <label><input type="checkbox" value="maintenance"> Maintenance</label>
                                </div>
                            </div>
                        </li>
					</ul>
				</div>
				<!-- <a href="#" class="btn-download">
					<i class='bx bxs-cloud-download' ></i>
					<span class="text">Download PDF</span>
				</a> -->
			</div>
					<div class="order">
						<table>
							<tbody>
                                <div class="projector-grid">
                                    <div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
									<div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
									<div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
									<div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
									<div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
									 <!-- More projector cards... -->
									<div class="projector-card" onclick="openOverlay(this)">
                                        <img src="img/DLP.webp" alt="Epson Projector">
                                        <div class="projector-details">
                                            <h3>Epson 703HD Powerlite Home Cinema LCD Projector</h3>
                                                <p class="status available">AVAILABLE</p>
                                        </div>
                                    </div>
                                    <!-- More projector cards... -->
                                </div>
							</tbody>
						</table>
					</div>
				</div>			

			</div>
		</main>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->
	

	<div id="overlay" class="overlay">
		<div class="overlay-content">
			<span class="close-btn" onclick="closeOverlay()">&times;</span>
			<div class="item-details">
				<img id="overlay-img" src="" alt="Projector">
				<div class="details">
					<h2 id="overlay-title"></h2>
					<p id="overlay-status"></p>
					<div class="booking-details">
						<div class="date-picker">
							<h3>Select Date and Time</h3>
							<input type="date" id="booking-date" min="" required>
							<div class="time-slots">
								<div class="time-picker">
									<label for="start-time">Borrow Time:</label>
									<input type="time" id="start-time" required>
								</div>
							</div>
						</div>
						<div id="calendar"></div>
					</div>
					<button class="borrow-btn" onclick="handleBooking()">Book Now</button>
				</div>
			</div>
		</div>
	</div>

	<script src="script.js"></script>
</body>
</html>