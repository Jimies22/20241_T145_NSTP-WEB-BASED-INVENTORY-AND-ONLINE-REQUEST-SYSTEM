<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="../login/bootstrap/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="login.css" />

    <!-- Google reCAPTCHA JavaScript API -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- Google Sign-In JavaScript API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Add axios in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div class="logo">
      <img
        src="bootstrap/images/nstp_logo.png"
        alt="NSTP Logo"
        class="nstp_logo"
      />
      <div class="header-text">
        <h6>NSTP INVENTORY &</h6>
        <h6>ONLINE REQUEST</h6>
      </div>
    </div>

    <!-- Login Form -->
    <form
      onsubmit="onSubmit(event)"
      class="d-flex align-items-center justify-content-center vh-100"
    >
      <div class="circle">
        <div class="card text-center">
          <div class="card-body">
            <h1>WELCOME</h1>
            <div>
              <div class="form-floating mb-4">
                <input
                  type="email"
                  class="form-control"
                  id="floatingInput"
                  placeholder="name@example.com"
                  required
                />
                <label for="floatingInput"
                  ><i class="bi bi-person"></i>Email address</label
                >
              </div>
              <div class="form-floating mb-4">
                <input
                  type="password"
                  class="form-control"
                  id="floatingPassword"
                  placeholder="Password"
                  required
                />
                <label for="floatingPassword"
                  ><i class="bi bi-key"></i>Password</label
                >
              </div>
              <input type="checkbox" name="checkbox" id="checkbox" />
              <label class="checkbox" for="checkbox">Keep me logged in</label>

              <button type="submit" class="btn btn-primary mt-3">Login</button>
              <p class="line">
                ______________________________________________________________
              </p>

              <!-- Google Sign-In Button Placeholder -->
              <div
                id="google-signin-btn"
                class="d-flex justify-content-center mt-3 mb-5"
                style="width: 80%; margin: 0 auto; transform: scale(1.2)"
              ></div>

              <!-- Google reCAPTCHA v2 Checkbox -->
              <div
                class="g-recaptcha mt-3"
                data-sitekey="6LdpdngqAAAAABXlZ6UpxdThGZS6oED-hvfq6h_Q"
              ></div>
            </div>
          </div>
          <div class="nstp_bg"></div>
        </div>
      </div>
    </form>

    <script>
      // API base URL - update this to match your backend URL
      const API_URL = "http://localhost:3000/api";

      // Handle regular login
      async function onSubmit(event) {
        event.preventDefault();

        // Get reCAPTCHA response
        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
          alert("Please complete the reCAPTCHA.");
          return;
        }

        // Get form data
        const email = document.getElementById("floatingInput").value;
        const password = document.getElementById("floatingPassword");
        const rememberMe = document.getElementById("checkbox").checked;

        try {
          // Send login request to backend
          const response = await axios.post(`${API_URL}/auth/admin/login`, {
            email: email,
            password: password.value,
            recaptchaResponse: recaptchaResponse,
          });

          if (response.data.success) {
            // Store token in localStorage if "Remember Me" is checked
            if (rememberMe) {
              localStorage.setItem("authToken", response.data.data.token);
            } else {
              sessionStorage.setItem("authToken", response.data.data.token);
            }

            // Store admin info
            localStorage.setItem(
              "adminInfo",
              JSON.stringify(response.data.data.admin)
            );

            // Clear form
            password.value = "";
            grecaptcha.reset();

            // Redirect to dashboard
            window.location.href = "../User/Dashboard.html";
          }
        } catch (error) {
          console.error("Login error:", error);

          // Show error message
          const errorMessage =
            error.response?.data?.message || "Login failed. Please try again.";
          alert(errorMessage);

          // Clear password and reset reCAPTCHA
          password.value = "";
          grecaptcha.reset();
        }
      }

      // Handle Google Credential Response
      async function handleCredentialResponse(response) {
        try {
          const result = await axios.post(`${API_URL}/auth/google-login`, {
            credential: response.credential,
          });

          if (result.data.success) {
            // Store token
            localStorage.setItem("authToken", result.data.data.token);

            // Redirect to dashboard
            window.location.href = "../User/Dashboard.html";
          }
        } catch (error) {
          console.error("Google login error:", error);
          alert("Google login failed. Please try again.");
        }
      }

      // Initialize Google Sign-In API
      window.onload = function () {
        google.accounts.id.initialize({
          client_id:
            "941942178577-6i12rtiomnbbfgha49lna53lpbsggcbf.apps.googleusercontent.com",
          callback: handleCredentialResponse,
          auto_select: false,
        });

        google.accounts.id.renderButton(
          document.getElementById("google-signin-btn"),
          {
            theme: "outline",
            size: "large",
            type: "standard",
            shape: "rectangular",
            logo_alignment: "center",
            text: "signin_with",
            width: "305",
          }
        );

        google.accounts.id.cancel();
      };

      // Utility function to check auth state
      function checkAuth() {
        const token =
          localStorage.getItem("authToken") ||
          sessionStorage.getItem("authToken");
        if (token) {
          window.location.href = "../User/Dashboard.html";
        }
      }

      // Check auth state on page load
      checkAuth();
    </script>
  </body>
</html>
